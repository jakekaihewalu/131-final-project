---
title: "PSTAT175Project"
author: "Jasmine Kellogg"
date: "11/13/2019"
output: html_document
---

```{r setup, include=FALSE}
r = getOption("repos")
r["CRAN"] = "http://cran.us.r-project.org"
options(repos = r)
knitr::opts_chunk$set(echo = TRUE)
install.packages('plyr')
library(tidyr)
library(dplyr)
library(plyr)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
getwd()
setwd("/Users/Jasmine/Downloads")
playerData = read.csv("player_data.csv")  # read csv file
print(head(playerData))
playerSeasonStats = read.csv("Seasons_Stats.csv")
print(head(playerSeasonStats))
```

##Rename Cols
```{r pressure, echo=FALSE}
colnames(playerSeasonStats)
names(playerSeasonStats)[names(playerSeasonStats) == "Player"] <- "name"
#playerSeasonStats

#merge data sets
total <- merge(playerData ,playerSeasonStats,by="name")
head(total)
```

```{r}
keeps <- c("name","year_start","year_end", "height", "weight", "college", "Year", "position", "WS", "FG.", "PTS")
df = total[keeps]

#some players played for multiple teams in a year, 
new = plyr::ddply(df,c("name","year_start","year_end", "height", "weight", "college", "position"),function(x){
  data.frame(WS=mean(x$WS), FG.=mean(x$FG.), PTS = sum(x$PTS))
})




new$retired <- 1
new$retired[new$year_end == 2018] <- 0
new$multiplepos <- 0 
new$multiplepos[(new$position == "G" & new$retired == 1)|(new$position == "F"& new$retired == 1)|(new$position == "C"& new$retired == 1)] <- 1

head(new[2:6,])

```




```{r}
summary(new$weight)
hist(new$WS,col = 'red',main='Histogram of Win Shares',
     xlab = 'Win Share Metric')

#summary(new[c('weight_class','time_start','wsclass','posclass','career_length')])
```
```{r}
# categorizing weight classes 
# range weight from 130 to 360 
diff <- 77
new$weight_class <- new$weight
new$weight_class <- ifelse((new$weight>=130 & new$weight<=207) , 1, new$weight_class)
new$weight_class <- ifelse((new$weight>207 & new$weight<=284) , 2 ,new$weight_class)
new$weight_class <- ifelse((new$weight>284 & new$weight<=361) , 3 ,new$weight_class)

#new$weight_class
#284+77



new

keeps <- c("wsclass","posclass","time_start",'retired','career_length')
df = new[keeps]
```


```{r}
new$career_length <- new$year_end - new$year_start + 1
#add new column for career length

#plot density for NBA career length
d <- density(new$career_length)
plot(d, main="Kernel Density of Player Career Length",xlab='Career Length in Years')
polygon(d, col="blue", border="black")
```

```{r}
### add column to classify year start
new$time_start <- new$year_start
new$time_start <- ifelse((new$year_start>=1940 & new$year_start<=1960) , 1 , new$time_start)
new$time_start <- ifelse((new$year_start>1960 & new$year_start<=1980) , 2 , new$time_start)
new$time_start <- ifelse((new$year_start>1980 & new$year_start<=2000) , 3 , new$time_start)
new$time_start <- ifelse((new$year_start>2000 & new$year_start<=2020) , 4 , new$time_start)



```

```{r}
library(survival)
new.time = new$career_length
new.event = new$retired
new.time

new.surv = Surv(new.time,new.event == 1)
new.fit = survfit(new.surv~1)
plot(new.fit, main = 'Kaplan Meier Curve \n for NBA Players', xlab = 'Time Until Retirement in Years', ylab = 'S(t)',
     col=c('red'))

```

```{r}
#add column to classify winshares
new$wsclass <- new$WS
new$wsclass <- ifelse((new$WS >= -1.750 & new$WS <= 0.100) , 1, new$wsclass)
new$wsclass <- ifelse((new$WS > 0.100 & new$WS <= 1.528) , 2, new$wsclass)
new$wsclass <- ifelse((new$WS > 1.528 & new$WS <= 2.400) , 3, new$wsclass)
new$wsclass <- ifelse((new$WS > 2.400 & new$WS <= 17.950) , 4, new$wsclass)
```

```{r}
#add column to classify position
new$posclass <- new$position
new$posclass <- ifelse(NA, new$posclass)
new$posclass <- ifelse((new$position == "G") , 1, new$posclass)
new$posclass <- ifelse((new$position == "F") , 2, new$posclass)
new$posclass <- ifelse((new$position == "C") , 3, new$posclass)

new$position


hist(new$wsclass)

```


```{r}
## KM Curves for all covariates of interest 
##win shares
new.ws = survfit(new.surv~wsclass,data=new)
par(mar=c(5,5,4,2))
plot(new.ws,main = 'Kaplan Meier Curve \n for Win Share Class', xlab = 'Time Until Retirement in Years',ylab = expression(hat(S)(t)),lwd=2,
     col=c("blue","green","red","purple"), mark.time = TRUE,mark=18)
legend("topright",legend=c("-1.75 to 0.1 WS","0.11 to 1.528 WS","1.529 to 2.4 WS", "2.41 to 17.95 WS"),col=c("blue","green","red","purple"),pch=rep(19,2))

#sort(new$career_length[new$wsclass == 2],decreasing = TRUE)
```

```{r}
##position
new.event1 = new$multiplepos
new.surv1 = Surv(new.time,new.event1 == 1)
new.ps = survfit(new.surv1~posclass,data=new)
par(mar=c(5,5,4,2))
plot(new.ps,main='Kaplan Meier Curve \n for Postion Class', xlab = 'Time Until Retirement in Years',ylab = expression(hat(S)(t)),lwd=2,
     col=c("blue","red","green"), mark.time = TRUE,mark=18)
legend("topright",legend=c("G","F","C"),
       col=c("blue","red","green"),pch=rep(19,2))

#sort(new$career_length[new$posclass == 3],decreasing = TRUE)
#new$posclass
```

```{r}
## weight 
new.WC = survfit(new.surv~weight_class,data=new)
plot(new.WC,col=c('red','blue','green'), main = 'Kaplan Meier Curve \n for Weight Class', xlab = 'Time Until Retirement in Years', ylab = expression(hat(S)(t)),lwd=2,mark.time = TRUE,mark=18)
legend("topright",legend=c("Weight Class 1 (130-207lbs)","Weight Class 2 (208-284lbs)",'Weight Class 3 (285-361lbs)'),
       col=c("red","blue",'green'),pch=rep(19,2))
```

```{r}
### decade start
new.ys = survfit(new.surv~time_start,data=new)
plot(new.ys,col=c('red','blue','green','purple'), main = 'Kaplan Meier Curve \n for Career Start Class', xlab = 'Time Until Retirement in Years', ylab = expression(hat(S)(t)),lwd=2,mark.time = TRUE,mark=18)
legend("topright",legend=c("1940-1960","1961-1980",'1981-2000','2001-2020'),
       col=c("red","blue",'green','purple'),pch=rep(19,2))

#sort(new$career_length[new$decade_start == 2],decreasing = TRUE)
```
```{r}
### changing covariates to factors 
new$weight_class <- as.factor(new$weight_class)
new$posclass <- as.factor(new$posclass)
new$time_start <- as.factor(new$time_start)
new$wsclass <- as.factor(new$wsclass)




keeps <- c('name',"wsclass",'weight_class',"posclass","time_start",'retired','career_length')
new[keeps][2:6,]
```


### LogRank Tests
```{r}
#logrank test for each variable, if p values are smaller than 0.05 then variables have a significant effect on NBA player career length

#logrank test for ws
new.wsdiff <- survdiff(Surv(new$career_length,new$retired)~new$wsclass)
new.wsdiff

#logrank test for position
new.posdiff <- survdiff(Surv(new$career_length,new$multiplepos)~new$posclass)
new.posdiff

#logrank test for decade started
new.startdiff <- survdiff(Surv(new$career_length,new$retired)~new$time_start)
new.startdiff

#logrank test for weight
new.weightdiff <- survdiff(Surv(new$career_length,new$retired)~new$weight_class)
new.weightdiff
```


### CoxPH Models
```{r}

cox_full <- coxph(Surv(career_length,retired)~weight_class + posclass + wsclass + time_start,data=new)
anova(cox_full)

step(cox_full,direction = 'backward')
```
```{r}
### start building the models one covariate at a time
### start with wsclass

cox_1 <- coxph(Surv(career_length,retired)~ wsclass,data=new)
summary(cox_1)
```

```{r}
cox_2 <- coxph(Surv(career_length,retired)~ wsclass + time_start,data=new)
summary(cox_2)
```

```{r}
lrt1 <- 2*(cox_2$loglik[2] - cox_1$loglik[2])
pchisq(lrt1,df=3,lower.tail = FALSE)
### we choose the model with decade_start AND wsclass
```

```{r}
cox_3 <- coxph(Surv(career_length,retired) ~ wsclass + time_start + posclass,data=new) 
summary(cox_3)
```

```{r}
lrt2 <- 2*(cox_3$loglik[2] - cox_2$loglik[2])
pchisq(lrt2,df=2,lower.tail = FALSE)
### we choose the full model with all three covariates
```

## Backward step regression to confirm our model
```{r}
cox_red <- coxph(Surv(career_length,retired) ~ wsclass,data=new)
cox.zph(cox_red)
#step(cox_3,direction = 'backward')
```

## Cox.zph test 
```{r}
cox.zph(cox_3)
```

### Clog-clog
```{r}
cox_pos <-  coxph(Surv(career_length,retired)~ posclass,data=new)
plot(survfit(cox_pos,newdata=data.frame(posclass=factor(c("1", "2",'3')))), 
     xlab="Time Until Retirement in Years ",ylab="log(-log(S(t)))",lwd=2, col = c(1,3,5), main = 'Log-log Test for Time Period Career Began',fun = 'cloglog')
legend("topleft",c("1","2",'3'),fill=c(1,3,5))

```

```{r}
cox_ws <-coxph(Surv(career_length,retired)~ wsclass,data=new)
plot(survfit(cox_ws), 
     xlab="Time Until Retirement in Years ",ylab="log(-log(S(t)))",lwd=2, col = c(1,3,5),main = 'Log-log Test for Time Period Career Began',fun = 'cloglog')
legend("topleft",c("1","2",'3'),fill=c(1,3,5))
```

```{r}
cox_strat <- coxph(Surv(career_length,retired) ~ strata(wsclass) + strata(time_start) + posclass, data=new)
cox_int <- coxph(Surv(career_length,retired) ~ strata(wsclass) + strata(time_start) + posclass + strata(wsclass)*posclass,data=new)
summary(cox_int)
summary(cox_strat)


lrt2 <- 2*(cox_int$loglik[2] - cox_strat$loglik[2])
pchisq(lrt2,df=6,lower.tail = FALSE)

summary(cox_strat)
```





```{r}
hist(new$career_length[new$retired ==1],breaks=5,col="cyan")
amlfit <- survreg(Surv(career_length,retired)~wsclass + time_start + posclass,data=new,dist="lognormal")
amlwfit <- survreg(Surv(career_length,retired)~wsclass + time_start + posclass,data=new,dist="weibull")
summary(amlfit)
amllogfit <- survreg(Surv(career_length,retired)~ wsclass + time_start + posclass,data=new,dist="loglogistic")
amlfit.e <-survreg(Surv(career_length,retired)~ wsclass + time_start + posclass,data=new,dist="exponential")

anova(amlwfit)
```
```{r}
bhaz$strata
```


```{r}
bhaz = basehaz(coxph(Surv(career_length,retired) ~ strata(time_start)+posclass+strata(wsclass),data=new))
ggplot(bhaz)+ geom_line(aes(x=time,y=hazard,colour=strata), size=2)

bhaz$hazard

```

```{r}
nbafit.KM <- survfit(Surv(career_length,retired)~wsclass,data=new)
plot(log(nbafit.KM$time),log(-log(nbafit.KM$surv)),pch=20, type="b",main = 'Weibull Log Odds for wsclass',
xlab="Log Time",ylab = 'Log Odds',xlim = c(0,2.5))

```


```{r}
nbawfit <- survreg(Surv(career_length,retired)~wsclass + 
time_start + posclass,data=new,dist="weibull")
summary(nbawfit)
```

```{r}
km <- Surv(new$career_length,new$retired)
plot(survfit(km~1),col = 'blue')
lines(survfit(cox_3),col='orange')
lines()

#cox_strat$

```


Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
